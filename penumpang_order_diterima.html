<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Tracking Penumpang</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* ... (CSS tetap sama) ... */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marker-alt"></i> Live Tracking Penumpang</h1>
            <p>Lacak perjalanan Anda secara real-time</p>
        </header>

        <div class="main-content">
            <!-- ... (HTML tetap sama) ... -->
        </div>
        
        <div class="footer">
            <p>Â© 2025 Live Tracking App | Pesanan Anda Aman dan Terlacak</p>
        </div>
    </div>

    <div id="connection-status" class="connection-status connected">
        <i class="fas fa-wifi"></i> Terhubung ke Firebase
    </div>

    <script>
        // Ambil parameter URL
        const urlParams = new URLSearchParams(window.location.search);
        const mapboxToken = urlParams.get('mapbox_token');
        const firebaseURL = urlParams.get('firebase_url');
        // Kita ambil userID dari parameter. Di URL contoh, parameter yang ada adalah order_id, tapi isinya userID
        const userId = urlParams.get('user_id') || urlParams.get('order_id');
        const firebaseBucket = 'pesanan';
        
        // Konfigurasi Mapbox
        mapboxgl.accessToken = mapboxToken;
        
        // Inisialisasi Firebase
        const firebaseConfig = {
            databaseURL: firebaseURL
        };
        
        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Referensi ke data pesanan, dan kita akan query berdasarkan userID
        const ordersRef = database.ref(firebaseBucket);
        
        // Variabel global untuk data dan peta
        let map, driverMarker, pickupMarker, destinationMarker, currentOrder;
        
        // Format plat nomor
        function formatPlate(plate) {
            if (plate && plate.length === 8) {
                return `${plate.substring(0, 2)} ${plate.substring(2, 6)} ${plate.substring(6)}`;
            }
            return plate || '-';
        }
        
        // Fungsi untuk memperbarui peta
        function updateMap(order) {
            if (!map) {
                // Inisialisasi peta jika belum ada
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [order.from_lng, order.from_lat],
                    zoom: 14
                });
                
                // Tambahkan kontrol navigasi
                map.addControl(new mapboxgl.NavigationControl());
            }
            
            // Hapus marker lama jika ada
            if (driverMarker) driverMarker.remove();
            if (pickupMarker) pickupMarker.remove();
            if (destinationMarker) destinationMarker.remove();
            
            // Tambahkan marker untuk lokasi penjemputan
            pickupMarker = new mapboxgl.Marker({ color: '#1a2a6c', scale: 1.2 })
                .setLngLat([order.from_lng, order.from_lat])
                .setPopup(new mapboxgl.Popup().setHTML(`<b>Titik Penjemputan</b><br>${order.alamat_a}`))
                .addTo(map);
            
            // Tambahkan marker untuk lokasi tujuan
            destinationMarker = new mapboxgl.Marker({ color: '#b21f1f', scale: 1.2 })
                .setLngLat([order.to_lng, order.to_lat])
                .setPopup(new mapboxgl.Popup().setHTML(`<b>Titik Tujuan</b><br>${order.alamat_b}`))
                .addTo(map);
            
            // Tambahkan marker untuk lokasi driver
            driverMarker = new mapboxgl.Marker({ color: '#fdbb2d', scale: 1.5 })
                .setLngLat([order.lng_driver, order.lat_driver])
                .setPopup(new mapboxgl.Popup().setHTML(`<b>Driver</b><br>${order.driverName}<br>${formatPlate(order.driverID)}`))
                .addTo(map);
            
            // Tambahkan garis rute
            if (map.getSource('route')) {
                map.removeLayer('route');
                map.removeSource('route');
            }
            
            map.addSource('route', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': [
                            [order.lng_driver, order.lat_driver],
                            [order.from_lng, order.from_lat],
                            [order.to_lng, order.to_lat]
                        ]
                    }
                }
            });
            
            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#1a2a6c',
                    'line-width': 4,
                    'line-dasharray': [2, 2]
                }
            });
            
            // Zoom ke seluruh rute
            const bounds = new mapboxgl.LngLatBounds();
            bounds.extend([order.lng_driver, order.lat_driver]);
            bounds.extend([order.from_lng, order.from_lat]);
            bounds.extend([order.to_lng, order.to_lat]);
            map.fitBounds(bounds, { padding: 100 });
        }
        
        // Fungsi untuk memperbarui UI
        function updateUI(order) {
            // Update informasi driver
            document.getElementById('driver-avatar').textContent = order.driverName ? order.driverName.charAt(0) : '-';
            document.getElementById('driver-name').textContent = order.driverName || '-';
            document.getElementById('driver-plate').textContent = formatPlate(order.driverID);
            
            // Update detail perjalanan
            document.getElementById('duration').textContent = order.durasi || '-';
            document.getElementById('distance').textContent = order.jarak || '-';
            document.getElementById('vehicle').textContent = order.vehicle || '-';
            document.getElementById('price').textContent = order.harga || '-';
            document.getElementById('pickup-address').textContent = order.alamat_a || '-';
            document.getElementById('destination-address').textContent = order.alamat_b || '-';
            
            // Update detail tambahan
            document.getElementById('passenger-name').textContent = order.name || '-';
            document.getElementById('passenger-phone').textContent = order.PhoneNumber || '-';
            document.getElementById('order-time').textContent = order.waktu_order || '-';
            document.getElementById('order-status').textContent = order.status || '-';
            
            // Update status
            const statusText = getStatusText(order.status);
            document.getElementById('status-indicator').textContent = statusText;
            
            // Update jarak
            const distance = calculateDistance(
                order.lat_driver, 
                order.lng_driver, 
                order.from_lat, 
                order.from_lng
            );
            document.getElementById('distance-info').textContent = `${distance.toFixed(1)} km`;
            
            // Update progress bar
            updateProgressBar(order.status);
        }
        
        // Fungsi untuk mendapatkan teks status
        function getStatusText(status) {
            const statusMap = {
                'menunggudriver': 'Mencari Driver',
                'diambil': 'Driver Menuju Ke Lokasi Anda',
                'tiba_di_jemput': 'Driver Telah Tiba di Lokasi Penjemputan',
                'perjalanan': 'Dalam Perjalanan Menuju Tujuan',
                'selesai': 'Perjalanan Selesai'
            };
            return statusMap[status] || status;
        }
        
        // Fungsi untuk menghitung jarak
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius bumi dalam km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
        
        // Fungsi untuk memperbarui progress bar
        function updateProgressBar(status) {
            const progressMap = {
                'menunggudriver': 10,
                'diambil': 30,
                'tiba_di_jemput': 50,
                'perjalanan': 70,
                'selesai': 100
            };
            
            const progress = progressMap[status] || 0;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            // Update step aktif
            const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
            const statusIndex = Object.keys(progressMap).indexOf(status);
            steps.forEach((stepId, index) => {
                const step = document.getElementById(stepId);
                if (index <= statusIndex) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }
        
        // Dengarkan perubahan pada data pesanan
        ordersRef.orderByChild('userID').equalTo(userId).on('value', (snapshot) => {
            const orders = snapshot.val();
            if (orders) {
                // Karena query bisa kembalikan banyak, kita ambil yang pertama
                const orderKeys = Object.keys(orders);
                if (orderKeys.length > 0) {
                    const orderId = orderKeys[0];
                    const orderData = orders[orderId];
                    currentOrder = orderData;
                    
                    // Perbarui UI
                    updateUI(orderData);
                    
                    // Perbarui peta
                    updateMap(orderData);
                    
                    // Perbarui koneksi status
                    document.getElementById('connection-status').className = 'connection-status connected';
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-wifi"></i> Terhubung ke Firebase';
                    
                    // Sembunyikan loading state
                    document.querySelector('#map .loading').style.display = 'none';
                    
                    console.log('Data Firebase yang diterima:', orderData);
                } else {
                    showNoData();
                }
            } else {
                showNoData();
            }
        }, (error) => {
            showError(error);
        });
        
        function showNoData() {
            document.getElementById('status-indicator').textContent = "Tidak ada pesanan aktif";
            document.querySelector('#map .loading').innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><br>Data pesanan tidak ditemukan</div>';
        }
        
        function showError(error) {
            document.getElementById('connection-status').className = 'connection-status disconnected';
            document.getElementById('connection-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Gagal terhubung ke Firebase';
            document.querySelector('#map .loading').innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><br>Gagal memuat data dari Firebase</div>';
            console.error('Error Firebase:', error);
        }
        
        // Event listener untuk tombol
        document.getElementById('btn-call').addEventListener('click', () => {
            if (currentOrder && currentOrder.PhoneNumber) {
                window.location.href = `tel:${currentOrder.PhoneNumber}`;
            } else {
                alert('Nomor telepon driver tidak tersedia');
            }
        });
        
        document.getElementById('btn-cancel').addEventListener('click', () => {
            if (confirm('Apakah Anda yakin ingin membatalkan pesanan?')) {
                if (currentOrder) {
                    // Update status di Firebase
                    // Kita perlu tahu key pesanan
                    ordersRef.orderByChild('userID').equalTo(userId).once('value', (snapshot) => {
                        const orders = snapshot.val();
                        if (orders) {
                            const orderKey = Object.keys(orders)[0];
                            database.ref(`${firebaseBucket}/${orderKey}`).update({
                                status: 'dibatalkan_penumpang'
                            });
                            alert('Pesanan telah dibatalkan');
                        }
                    });
                }
            }
        });
        
        // Mode demo hanya jika tidak ada koneksi Firebase
        setTimeout(() => {
            if (!currentOrder) {
                document.getElementById('connection-status').className = 'connection-status disconnected';
                document.getElementById('connection-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Mode Demo (Data Statis)';
            }
        }, 5000);
    </script>
</body>
</html>
