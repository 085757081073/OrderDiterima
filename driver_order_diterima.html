<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Order Diterima</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: sans-serif;
      background-color: #ffffff;
      display: flex;
      flex-direction: column;
    }
    #map {
      height: 50%;
      width: 100%;
    }
    #info {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }
    .label {
      font-weight: bold;
      color: #333;
    }
    .value {
      margin-bottom: 10px;
      display: block;
    }
    .button {
      margin-top: 10px;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
    }
    .button:active {
      opacity: 0.8;
    }
    #loading {
      color: #888;
      font-size: 14px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info">
    <div id="loading">Sedang mengambil data order. Jangan batalkan orderan jika informasi belum tampil. Cek koneksi internet Anda.</div>
    <div><span class="label">ğŸ§ Nama:</span> <span id="name" class="value"></span></div>
    <div><span class="label">ğŸ“ Dari:</span> <span id="alamat_a" class="value"></span></div>
    <div><span class="label">ğŸ Tujuan:</span> <span id="alamat_b" class="value"></span></div>
    <div><span class="label">ğŸ“ Jarak:</span> <span id="jarak" class="value" style="font-size: 18px; color: #007bff;"></span></div>
    <div><span class="label">ğŸ’° Harga:</span> <span id="harga" class="value" style="font-size: 18px; color: #28a745;"></span></div>

    <button class="button" onclick="navigateTo('a')">ğŸš— Navigasi ke Penjemputan</button>
    <button class="button" onclick="navigateTo('b')">ğŸ›£ï¸ Navigasi ke Tujuan</button>
    <button class="button" onclick="sendWebString('chat')">ğŸ’¬ Chat Penumpang</button>
    <button class="button" onclick="sendWebString('tiba')">ğŸ“ Saya Sudah Tiba</button>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const fromLat = parseFloat(params.get("from_lat"));
    const fromLng = parseFloat(params.get("from_lng"));
    const toLat = parseFloat(params.get("to_lat"));
    const toLng = parseFloat(params.get("to_lng"));
    const name = params.get("name");
    const alamat_a = params.get("alamat_a");
    const alamat_b = params.get("alamat_b");
    const jarak = params.get("jarak");
    const harga = params.get("harga");
    const vehicle = (params.get("vehicle") || "motor").toLowerCase();
    const apiKey = params.get("apiKey");

    document.getElementById("name").textContent = name || "-";
    document.getElementById("alamat_a").textContent = alamat_a || "-";
    document.getElementById("alamat_b").textContent = alamat_b || "-";
    document.getElementById("jarak").textContent = jarak || "-";
    document.getElementById("harga").textContent = harga || "-";

    function navigateTo(target) {
      const lat = target === "a" ? fromLat : toLat;
      const lng = target === "a" ? fromLng : toLng;
      sendWebString("navigate:" + lat + "," + lng);
    }

    function sendWebString(value) {
      if (window.AppInventor) {
        window.AppInventor.setWebViewString(value);
      } else {
        alert("WebViewString: " + value);
      }
    }

    const iconUrls = {
      motor: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
      mobil: 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
      kurir: 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png',
      bentor: 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png',
      pickup: 'https://cdn-icons-png.flaticon.com/512/9017/9017605.png',
      pickup_scooter: 'https://cdn-icons-png.flaticon.com/128/3177/3177363.png'
    };

    function initMap() {
      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer();
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: { lat: fromLat, lng: fromLng }
      });
      directionsRenderer.setMap(map);

      const iconURL = iconUrls[vehicle] || "https://maps.google.com/mapfiles/ms/icons/red-dot.png";

      new google.maps.Marker({
        position: { lat: fromLat, lng: fromLng },
        map,
        icon: {
          url: iconURL,
          scaledSize: new google.maps.Size(40, 40)
        },
        title: "Lokasi Penjemputan"
      });

      const request = {
        origin: { lat: fromLat, lng: fromLng },
        destination: { lat: toLat, lng: toLng },
        travelMode: 'DRIVING'
      };

      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
        } else {
          alert('Gagal memuat arah: ' + status);
        }
      });

      document.getElementById("loading").style.display = "none";
    }
  </script>
  <script async defer id="maps-api" src=""></script>
  <script>
    const src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&callback=initMap`;
    document.getElementById("maps-api").src = src;
  </script>
</body>
</html>
