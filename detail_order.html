<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Detail Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #ffffff;
      font-weight: bold;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    
    .countdown {
      width: 100%;
      text-align: center;
      font-size: 13px;
      font-weight: bold;
      background: rgba(255,255,255,0.95);
      padding: 8px 0;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #map-container {
      position: relative;
      flex-grow: 1;
      width: 100%;
    }
    
    #map {
      height: 100%;
      width: 100%;
      background: #e9e9e9;
    }
    
    .map-nav-buttons {
      position: absolute;
      bottom: 15px;
      right: 10px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .map-nav-buttons button {
      padding: 10px 12px;
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
      min-width: 110px;
    }
    
    .order-detail {
      padding: 12px 15px;
      background: white;
      border-top: 1px solid #e0e0e0;
      flex-shrink: 0;
      max-height: 45vh;
      overflow-y: auto;
    }
    
    .address-card {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      border-left: 3px solid #4285F4;
    }
    
    .address-card h3 {
      margin: 0 0 6px 0;
      font-size: 13px;
      color: #555;
    }
    
    .address-card p {
      margin: 0;
      font-size: 14px;
      line-height: 1.4;
      color: #333;
    }
    
    .price-display {
      text-align: center;
      margin: 12px 0;
      padding: 10px;
      background: #f0f8ff;
      border-radius: 6px;
      font-weight: bold;
    }
    
    .price-display .amount {
      font-size: 18px;
      color: #2e7d32;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .action-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }
    
    .chat-btn {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .cancel-btn {
      background: #ffebee;
      color: #d32f2f;
    }
    
    .arrival-btn {
      background: #f0f0f0;
      color: #888;
      cursor: not-allowed;
      width: 100%;
    }
    
    .arrival-btn.active {
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 2000;
      display: none;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; top: 10px; }
      to { opacity: 1; top: 20px; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div id="passenger-name">Memuat data...</div>
    <button class="cancel-btn" onclick="cancelOrder()">‚úñ Batalkan</button>
  </div>

  <div class="countdown" id="countdown-info">Menghitung jarak...</div>

  <div id="map-container">
    <div id="map"></div>
    <div class="map-nav-buttons">
      <button onclick="navigateTo('pickup')">
        <span style="font-size:16px">üß≠</span> Ke Penjemputan
      </button>
      <button onclick="navigateTo('dropoff')">
        <span style="font-size:16px">üìç</span> Ke Tujuan
      </button>
    </div>
  </div>

  <div class="order-detail">
    <div class="address-card">
      <h3>LOKASI PENJEMPUTAN</h3>
      <p id="pickup-address">Memuat alamat penjemputan...</p>
    </div>
    
    <div class="address-card">
      <h3>LOKASI TUJUAN</h3>
      <p id="dropoff-address">Memuat alamat tujuan...</p>
    </div>
    
    <div class="price-display">
      <div>TOTAL BIAYA</div>
      <div id="price" class="amount">Rp -</div>
    </div>
    
    <div class="action-buttons">
      <button class="chat-btn" onclick="chatUser()">üí¨ Chat Pelanggan</button>
    </div>
    
    <button class="arrival-btn" id="arrivalBtn">Saya sudah tiba</button>
  </div>

  <div class="notification" id="notification"></div>

  <!-- Mapbox JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <!-- Mapbox Directions Plugin -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Global variables
    let map;
    let directions;
    let driverMarker;
    let orderRef;
    let isNearPickup = false;
    let isPickupCompleted = false;
    let pelangganPhone = '';
    let pickupCoords, dropoffCoords;

    // Initialize Mapbox
    function initMapbox() {
      const urlParams = new URLSearchParams(window.location.search);
      const mapboxToken = urlParams.get('mapboxToken');
      
      if (!mapboxToken) {
        showNotification("Mapbox token tidak ditemukan", true);
        return null;
      }
      
      mapboxgl.accessToken = mapboxToken;
      
      // Initialize map
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [106.8, -6.2], // Default Jakarta
        zoom: 13
      });
      
      // Add zoom controls
      map.addControl(new mapboxgl.NavigationControl());
      
      // Initialize directions
      directions = new MapboxDirections({
        accessToken: mapboxgl.accessToken,
        unit: 'metric',
        profile: 'mapbox/driving',
        controls: {
          inputs: false,
          instructions: false,
          profileSwitcher: false
        },
        interactive: false
      });
      
      map.addControl(directions, 'top-left');
      
      return map;
    }

    // Show notification
    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.background = isError ? '#FF5252' : '#4CAF50';
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Format currency
    function formatCurrency(amount) {
      if (amount === undefined || amount === null) return "Rp -";
      const num = parseInt(String(amount).replace(/\D/g, ''));
      return isNaN(num) ? "Rp -" : "Rp" + num.toLocaleString('id-ID');
    }

    // Send webstring to native app
    function sendWebString(action) {
      const webString = `webstring:${action}`;
      if (window.AndroidInterface) {
        window.AndroidInterface.setWebViewString(webString);
      } else if (window.webkit && window.webkit.messageHandlers) {
        window.webkit.messageHandlers.observer.postMessage(webString);
      }
      console.log(webString);
    }

    // Navigation handler
    function navigateTo(type) {
      if (!pickupCoords || !dropoffCoords) {
        showNotification("Lokasi belum dimuat", true);
        return;
      }
      
      const coords = type === 'pickup' ? pickupCoords : dropoffCoords;
      sendWebString(`navigate_${type}_${coords.lng},${coords.lat}`);
    }

    // Chat user handler
    function chatUser() {
      if (!pelangganPhone) {
        showNotification("Nomor pelanggan tidak tersedia", true);
        return;
      }
      sendWebString(`chat_${pelangganPhone}`);
    }

    // Cancel order
    function cancelOrder() {
      if (confirm("Apakah Anda yakin ingin membatalkan order ini?")) {
        sendWebString("cancel_order");
        if (orderRef) {
          orderRef.update({ 
            status_driver: "dibatalkan",
            waktu_batal: firebase.database.ServerValue.TIMESTAMP 
          }).then(() => {
            showNotification("Order telah dibatalkan");
          }).catch(error => {
            showNotification("Gagal membatalkan order", true);
          });
        }
      }
    }

    // Update driver position
    function updateDriverPosition(lat, lng) {
      const driverCoords = [lng, lat];
      
      // Update or create driver marker
      if (!driverMarker) {
        const el = document.createElement('div');
        el.className = 'driver-marker';
        el.style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/128/5811/5811823.png)';
        el.style.width = '40px';
        el.style.height = '40px';
        el.style.backgroundSize = '100%';
        
        driverMarker = new mapboxgl.Marker(el)
          .setLngLat(driverCoords)
          .addTo(map);
      } else {
        driverMarker.setLngLat(driverCoords);
      }
      
      // Calculate distance to pickup
      if (pickupCoords) {
        const distance = turf.distance(
          turf.point(driverCoords),
          turf.point([pickupCoords.lng, pickupCoords.lat]),
          { units: 'kilometers' }
        ) * 1000;
        
        const duration = Math.round(distance / 1000 / 0.4 * 60);
        document.getElementById('countdown-info').textContent = 
          `Jarak ke penjemputan: ${(distance/1000).toFixed(1)} km - Estimasi: ${duration} menit`;
        
        // Update arrival button state
        if (distance < 200 && !isPickupCompleted) {
          isNearPickup = true;
          document.getElementById('arrivalBtn').textContent = "Selesaikan Penjemputan";
          document.getElementById('arrivalBtn').classList.add('active');
          document.getElementById('arrivalBtn').disabled = false;
        }
      }
      
      // Update route
      if (pickupCoords && dropoffCoords) {
        if (!isPickupCompleted) {
          directions.setOrigin(driverCoords);
          directions.setDestination([pickupCoords.lng, pickupCoords.lat]);
        } else {
          directions.setOrigin(driverCoords);
          directions.setDestination([dropoffCoords.lng, dropoffCoords.lat]);
        }
      }
      
      // Update Firebase
      if (orderRef) {
        orderRef.update({
          lat_driver: lat,
          lng_driver: lng,
          last_update: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }

    // Start tracking position
    function startTracking() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            updateDriverPosition(position.coords.latitude, position.coords.longitude);
          },
          (error) => {
            console.error("Geolocation error:", error);
            showNotification("Gagal mendapatkan lokasi", true);
          },
          { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 }
        );
      } else {
        showNotification("Browser tidak mendukung geolocation", true);
      }
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      map = initMapbox();
      if (!map) return;
      
      const urlParams = new URLSearchParams(window.location.search);
      const apiKey = urlParams.get('apiKey');
      const databaseURL = urlParams.get('databaseURL');
      const orderId = urlParams.get('orderId');
      
      if (!apiKey || !databaseURL || !orderId) {
        showNotification("Parameter URL tidak lengkap", true);
        return;
      }
      
      // Initialize Firebase
      firebase.initializeApp({ apiKey, databaseURL });
      orderRef = firebase.database().ref(`pesanan/${orderId}`);
      
      // Load order data
      orderRef.on("value", (snapshot) => {
        const orderData = snapshot.val();
        if (!orderData) {
          showNotification("Data order tidak ditemukan", true);
          return;
        }
        
        // Update UI
        document.getElementById('passenger-name').textContent = orderData.name || "Pelanggan";
        document.getElementById('pickup-address').textContent = orderData.alamat_a || "Alamat tidak tersedia";
        document.getElementById('dropoff-address').textContent = orderData.alamat_b || "Alamat tidak tersedia";
        document.getElementById('price').textContent = formatCurrency(orderData.harga);
        pelangganPhone = orderData.PhoneNumber || '';
        
        // Set coordinates
        if (orderData.from_lat && orderData.from_lng) {
          pickupCoords = {
            lat: orderData.from_lat,
            lng: orderData.from_lng
          };
          
          new mapboxgl.Marker({ color: '#4CAF50' })
            .setLngLat([pickupCoords.lng, pickupCoords.lat])
            .setPopup(new mapboxgl.Popup().setHTML("<b>Lokasi Penjemputan</b>"))
            .addTo(map);
        }
        
        if (orderData.to_lat && orderData.to_lng) {
          dropoffCoords = {
            lat: orderData.to_lat,
            lng: orderData.to_lng
          };
          
          new mapboxgl.Marker({ color: '#FF5252' })
            .setLngLat([dropoffCoords.lng, dropoffCoords.lat])
            .setPopup(new mapboxgl.Popup().setHTML("<b>Lokasi Tujuan</b>"))
            .addTo(map);
        }
        
        // Fit bounds if both points exist
        if (pickupCoords && dropoffCoords) {
          const bounds = new mapboxgl.LngLatBounds();
          bounds.extend([pickupCoords.lng, pickupCoords.lat]);
          bounds.extend([dropoffCoords.lng, dropoffCoords.lat]);
          map.fitBounds(bounds, { padding: 50 });
        }
        
        // Start tracking
        startTracking();
      });
      
      // Arrival button handler
      document.getElementById('arrivalBtn').addEventListener('click', function() {
        if (!isPickupCompleted && isNearPickup) {
          // Complete pickup
          orderRef.update({ 
            status_driver: "tiba_di_jemput",
            waktu_tiba: firebase.database.ServerValue.TIMESTAMP 
          }).then(() => {
            showNotification("Penjemputan diselesaikan");
            this.textContent = "Mulai Mengantar";
            isPickupCompleted = true;
            sendWebString("pickup_completed");
          });
        } else if (isPickupCompleted) {
          // Start trip
          orderRef.update({ 
            status_driver: "dalam_pengantaran",
            waktu_berangkat: firebase.database.ServerValue.TIMESTAMP 
          }).then(() => {
            showNotification("Pesanan sedang diantar");
            this.textContent = "Sedang Mengantar...";
            this.disabled = true;
            sendWebString("trip_started");
          });
        }
      });
    });

    // Load Turf.js dynamically
    const turfScript = document.createElement('script');
    turfScript.src = 'https://unpkg.com/@turf/turf@6/turf.min.js';
    document.head.appendChild(turfScript);
  </script>
</body>
</html>
