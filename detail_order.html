<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Detail Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const from = params.get('from');
    const to = params.get('to');
    const vehicle = params.get('vehicle');
    const orderId = params.get('order_id');
    const firebaseURL = params.get('firebase_url');

    if (!token || !from || !to || !vehicle || !orderId || !firebaseURL) {
      alert('Parameter kurang');
      throw new Error('Parameter kurang');
    }

    mapboxgl.accessToken = token;

    // Fungsi untuk memastikan format koordinat [lng, lat]
    const parseCoord = (str) => {
      const [lat, lng] = str.split(',').map(Number);
      return [lng, lat];
    };

    const fromCoord = parseCoord(from);
    const toCoord = parseCoord(to);
    const vehicleParts = vehicle.split(',');
    const vehicleCoord = [parseFloat(vehicleParts[1]), parseFloat(vehicleParts[0])];
    const vehicleType = vehicleParts[2] || 'motor';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: vehicleCoord,
      zoom: 15
    });

    const iconUrls = {
  motor: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
  mobil: 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
  kurir: 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png',
  bentor: 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png',
  pickup: 'https://cdn-icons-png.flaticon.com/512/9017/9017605.png',
  pickup_scooter: 'https://cdn-icons-png.flaticon.com/128/3177/3177363.png',
  default: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png'
};

    const el = document.createElement('div');
    el.style.backgroundImage = `url(${vehicleIcons[vehicleType] || vehicleIcons.default})`;
    el.style.width = '40px';
    el.style.height = '40px';
    el.style.backgroundSize = 'cover';

    let vehicleMarker;
    let status = 'menuju_jemput';

    // Fungsi menghitung jarak dalam meter
    const distance = (coord1, coord2) => {
      const [lng1, lat1] = coord1;
      const [lng2, lat2] = coord2;
      const R = 6371e3; // Earth radius in meters
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lng2-lng1) * Math.PI/180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    };

    function addRoute(start, end) {
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&access_token=${token}`;
      
      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (!data.routes || data.routes.length === 0) {
            console.error("No routes found", data);
            throw new Error("No routes found");
          }
          
          const route = data.routes[0].geometry;
          
          if (map.getSource('route')) {
            map.getSource('route').setData({
              type: 'Feature',
              geometry: route
            });
          } else {
            map.addSource('route', {
              type: 'geojson',
              data: {
                type: 'Feature',
                geometry: route
              }
            });
            
            map.addLayer({
              id: 'route',
              type: 'line',
              source: 'route',
              layout: {
                'line-cap': 'round',
                'line-join': 'round'
              },
              paint: {
                'line-color': '#00BFFF',
                'line-width': 4
              }
            });
          }
        })
        .catch(err => {
          console.error("Error fetching route:", err);
          // Coba alternatif jika rute driving gagal
          setTimeout(() => addRoute(start, end), 2000);
        });
    }

    function updateFirebase(lat, lng, newStatus = null) {
      fetch(`${firebaseURL}/pesanan/${orderId}.json`, {
        method: 'PATCH',
        body: JSON.stringify({
          lat_driver: lat,
          lng_driver: lng,
          ...(newStatus ? { status: newStatus } : {})
        })
      }).catch(err => console.error("Firebase update error:", err));
    }

    map.on('load', () => {
      map.addControl(new mapboxgl.NavigationControl());

      // Tambahkan marker lokasi jemput dan tujuan
      new mapboxgl.Marker({ color: 'green' })
        .setLngLat(fromCoord)
        .setPopup(new mapboxgl.Popup().setText("Lokasi Jemput"))
        .addTo(map);
      
      new mapboxgl.Marker({ color: 'red' })
        .setLngLat(toCoord)
        .setPopup(new mapboxgl.Popup().setText("Lokasi Tujuan"))
        .addTo(map);

      // Tambahkan marker kendaraan
      vehicleMarker = new mapboxgl.Marker(el)
        .setLngLat(vehicleCoord)
        .addTo(map);

      // Sesuaikan viewport
      const bounds = new mapboxgl.LngLatBounds()
        .extend(fromCoord)
        .extend(toCoord)
        .extend(vehicleCoord);
      map.fitBounds(bounds, { padding: 100 });

      // Tambahkan rute awal
      addRoute(vehicleCoord, fromCoord);

      // Update posisi secara berkala
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const currentCoord = [lng, lat];

            vehicleMarker.setLngLat(currentCoord);
            updateFirebase(lat, lng);

            if (status === 'menuju_jemput') {
              const distToPickup = distance(currentCoord, fromCoord);
              if (distToPickup < 100) { // 100 meter
                status = 'menuju_tujuan';
                updateFirebase(lat, lng, 'tiba_di_jemput');
                addRoute(currentCoord, toCoord);
              }
            } else if (status === 'menuju_tujuan') {
              const distToDestination = distance(currentCoord, toCoord);
              if (distToDestination < 100) { // 100 meter
                status = 'selesai';
                updateFirebase(lat, lng, 'selesai');
                alert("Perjalanan selesai.");
              }
            }
          },
          err => {
            console.error("Geolocation error:", err);
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
      }, 5000);
    });
  </script>
</body>
</html>
