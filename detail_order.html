<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Detail Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #ffffff;
      font-weight: bold;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .countdown {
      position: absolute;
      top: 70px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255,255,255,0.9);
      padding: 10px 0;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #map {
      height: 300px;
      width: 100%;
      min-height: 250px;
      background: #e9e9e9;
    }
    .floating-nav {
      position: absolute;
      top: 110px;
      right: 15px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .floating-nav button {
      padding: 10px 15px;
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .order-detail {
      padding: 20px;
      background: white;
      margin-top: -5px;
    }
    .address {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin: 15px 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    .address p {
      margin: 0;
      width: 85%;
      line-height: 1.5;
      color: #333;
    }
    .price {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      color: #333;
    }
    .chat-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #4285F4;
      padding: 5px;
    }
    .cancel-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #FF5252;
      padding: 5px;
    }
    .arrival-btn {
      display: block;
      width: calc(100% - 40px);
      margin: 25px auto;
      padding: 15px;
      background: #f0f0f0;
      color: #888;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: not-allowed;
      text-align: center;
      transition: all 0.3s;
    }
    .arrival-btn.active {
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 12px 25px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 2000;
      display: none;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; top: 10px; }
      to { opacity: 1; top: 20px; }
    }
    .mapboxgl-ctrl-geocoder {
      width: 100% !important;
      max-width: 100% !important;
    }
    .mapbox-directions-component {
      width: 100% !important;
      max-width: 100% !important;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div id="passenger-name">Memuat data...</div>
    <button class="cancel-btn" onclick="cancelOrder()">âœ– Batalkan</button>
  </div>

  <div class="countdown" id="countdown-info">Menghitung jarak...</div>

  <div id="map"></div>

  <div class="floating-nav">
    <button onclick="openNativeNavigation('pickup')">
      <span style="font-size:18px">ðŸ§­</span> Jemput
    </button>
    <button onclick="openNativeNavigation('dropoff')">
      <span style="font-size:18px">ðŸ§­</span> Antar
    </button>
  </div>

  <div class="order-detail">
    <div class="address">
      <p id="pickup-address">Memuat alamat penjemputan...</p>
      <button class="chat-btn" onclick="chatUser()">ðŸ’¬</button>
    </div>
    <div class="address">
      <p id="dropoff-address">Memuat alamat tujuan...</p>
    </div>
    <div class="price" id="price">Rp -</div>
    <button class="arrival-btn" id="arrivalBtn">Saya sudah tiba</button>
  </div>

  <div class="notification" id="notification"></div>

  <!-- Mapbox JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <!-- Mapbox Directions Plugin -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Variabel global
    let map;
    let driverMarker, pickupMarker, dropoffMarker;
    let arrivalBtn = document.getElementById('arrivalBtn');
    let isNearPickup = false, isPickupCompleted = false;
    let pelangganPhone = '';
    let pickupCoords, dropoffCoords;
    let orderData = {};
    let directions;

    // Inisialisasi Mapbox
    function initMapbox() {
      const urlParams = new URLSearchParams(window.location.search);
      const mapboxToken = urlParams.get('mapboxToken');
      
      if (!mapboxToken) {
        showNotification("Mapbox token tidak ditemukan", true);
        return;
      }
      
      mapboxgl.accessToken = mapboxToken;
      
      // Inisialisasi peta
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [106.8, -6.2], // Default Jakarta
        zoom: 13
      });
      
      // Tambahkan kontrol navigasi
      map.addControl(new mapboxgl.NavigationControl());
      
      // Inisialisasi directions
      directions = new MapboxDirections({
        accessToken: mapboxgl.accessToken,
        unit: 'metric',
        profile: 'mapbox/driving',
        controls: {
          inputs: false,
          instructions: false,
          profileSwitcher: false
        },
        interactive: false
      });
      
      map.addControl(directions, 'top-left');
      
      // Set marker driver
      const el = document.createElement('div');
      el.className = 'driver-marker';
      el.style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/128/5811/5811823.png)';
      el.style.width = '40px';
      el.style.height = '40px';
      el.style.backgroundSize = '100%';
      
      driverMarker = new mapboxgl.Marker(el)
        .setLngLat([106.8, -6.2])
        .addTo(map);
    }

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.background = isError ? '#FF5252' : '#4CAF50';
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Fungsi untuk membuka navigasi di aplikasi maps native
    function openNativeNavigation(type) {
      if (!orderData) {
        showNotification("Data lokasi belum dimuat", true);
        return;
      }

      let lat, lng;
      if (type === 'pickup') {
        lat = orderData.from_lat;
        lng = orderData.from_lng || orderData.from_ing;
      } else {
        lat = orderData.to_lat;
        lng = orderData.to_lng || orderData.to_ing;
      }

      // URL untuk berbagai platform
      const urls = {
        android: `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`,
        ios: `maps://maps.google.com/maps?daddr=${lat},${lng}&directionsmode=driving`,
        web: `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`
      };

      // Deteksi perangkat
      const isAndroid = /Android/i.test(navigator.userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

      // Buka aplikasi maps sesuai platform
      if (isAndroid) {
        // Coba buka Google Maps di Android
        window.location.href = `google.navigation:q=${lat},${lng}`;
        setTimeout(() => {
          // Fallback ke Google Maps web jika gagal
          window.open(urls.android, '_blank');
        }, 500);
      } else if (isIOS) {
        // Buka Apple Maps di iOS
        window.location.href = urls.ios;
        setTimeout(() => {
          // Fallback ke Google Maps web jika gagal
          window.open(urls.web, '_blank');
        }, 500);
      } else {
        // Fallback untuk desktop/browser lain
        window.open(urls.web, '_blank');
      }
    }

    // Fungsi untuk memformat harga dengan benar
    function formatCurrency(amount) {
      if (amount === undefined || amount === null) return "Rp -";
      
      // Bersihkan format harga (hapus karakter non-digit)
      const cleanedAmount = String(amount).replace(/\D/g, '');
      const num = Number(cleanedAmount);
      
      if (isNaN(num)) return "Rp -";
      
      return "Rp" + num.toLocaleString('id-ID');
    }

    // Fungsi untuk chat pelanggan via WhatsApp
    function chatUser() {
      if (!pelangganPhone) {
        showNotification("Nomor pelanggan tidak tersedia", true);
        return;
      }
      
      // Format nomor telepon (pastikan diawali 62)
      const formattedPhone = pelangganPhone.replace(/^0/, '62').replace(/\D/g, '');
      const waUrl = `https://wa.me/${formattedPhone}`;
      
      window.open(waUrl, '_blank');
    }

    // Fungsi untuk membatalkan order
    function cancelOrder() {
      if (confirm("Apakah Anda yakin ingin membatalkan order ini?")) {
        if (orderRef) {
          orderRef.update({ 
            status_driver: "dibatalkan",
            waktu_batal: firebase.database.ServerValue.TIMESTAMP 
          }).then(() => {
            showNotification("Order telah dibatalkan");
            sendWebString("cancel_order");
            setTimeout(() => {
              document.body.innerHTML = `
                <div style="text-align:center;margin-top:50px;padding:20px;">
                  <h2>Order telah dibatalkan</h2>
                  <p>Silahkan tutup halaman ini</p>
                </div>`;
            }, 1500);
          }).catch(error => {
            showNotification("Gagal membatalkan order", true);
          });
        }
      }
    }

    // Fungsi untuk mengirim webstring ke native app
    function sendWebString(action) {
      if (window.AndroidInterface) {
        window.AndroidInterface.setWebViewString(`webstring:${action}`);
      } else if (window.webkit && window.webkit.messageHandlers) {
        // Untuk iOS
        window.webkit.messageHandlers.observer.postMessage(`webstring:${action}`);
      } else {
        console.log(`webstring:${action}`); // Fallback untuk debugging
      }
    }

    // Fungsi untuk update posisi driver
    function updateDriverPosition(lat, lng) {
      const driverCoords = [lng, lat];
      
      // Update marker posisi driver
      driverMarker.setLngLat(driverCoords);
      
      // Hitung jarak ke lokasi penjemputan (dalam meter)
      const distance = turf.distance(
        turf.point(driverCoords),
        turf.point([pickupCoords.lng, pickupCoords.lat]),
        { units: 'kilometers' }
      ) * 1000;
      
      const duration = Math.round(distance / 1000 / 0.4 * 60); // Asumsi 40km/jam
      
      document.getElementById('countdown-info').textContent = 
        `Jarak ke penjemputan: ${(distance/1000).toFixed(2)} km - Estimasi: ${duration} menit`;
      
      // Update status tombol berdasarkan jarak
      if (distance < 200 && !isPickupCompleted) {
        isNearPickup = true;
        arrivalBtn.textContent = "Selesaikan Penjemputan";
        arrivalBtn.classList.add('active');
        arrivalBtn.disabled = false;
      } else if (!isPickupCompleted) {
        isNearPickup = false;
        arrivalBtn.textContent = "Saya sudah tiba";
        arrivalBtn.classList.remove('active');
        arrivalBtn.disabled = true;
      }

      // Update posisi driver di Firebase
      if (orderRef) {
        orderRef.update({
          lat_driver: lat,
          lng_driver: lng,
          last_update: firebase.database.ServerValue.TIMESTAMP
        }).catch(error => {
          console.error("Gagal update posisi:", error);
        });
      }
      
      // Update rute jika sudah ada pickup dan dropoff
      if (pickupCoords && dropoffCoords) {
        updateRoute(driverCoords);
      }
    }

    // Fungsi untuk memperbarui rute
    function updateRoute(currentLocation) {
      if (!isPickupCompleted) {
        // Rute dari lokasi driver ke pickup point
        directions.setOrigin(currentLocation);
        directions.setDestination([pickupCoords.lng, pickupCoords.lat]);
      } else {
        // Rute dari lokasi driver ke dropoff point
        directions.setOrigin(currentLocation);
        directions.setDestination([dropoffCoords.lng, dropoffCoords.lat]);
      }
    }

    // Fungsi untuk memulai tracking posisi
    function startTracking() {
      if (navigator.geolocation) {
        const geoOptions = {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 30000
        };
        
        navigator.geolocation.watchPosition(
          (position) => {
            updateDriverPosition(position.coords.latitude, position.coords.longitude);
          },
          (error) => {
            console.error("Error geolocation:", error);
            showNotification("Gagal mendapatkan lokasi", true);
          },
          geoOptions
        );
      } else {
        showNotification("Browser tidak mendukung geolocation", true);
      }
    }

    // Inisialisasi Firebase dan load data
    const urlParams = new URLSearchParams(window.location.search);
    const apiKey = urlParams.get('apiKey');
    const databaseURL = urlParams.get('databaseURL');
    const orderId = urlParams.get('orderId');
    const mapboxToken = urlParams.get('mapboxToken');

    if (!apiKey || !databaseURL || !orderId || !mapboxToken) {
      showNotification("Parameter URL tidak lengkap", true);
      throw new Error("Missing required URL parameters");
    }

    // Inisialisasi Mapbox
    initMapbox();

    // Inisialisasi Firebase
    const firebaseConfig = { apiKey, databaseURL };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const orderRef = db.ref(`pesanan/${orderId}`);

    // Load Turf.js untuk perhitungan geospatial
    const turfScript = document.createElement('script');
    turfScript.src = 'https://unpkg.com/@turf/turf@6/turf.min.js';
    document.head.appendChild(turfScript);

    // Load data order
    orderRef.on("value", (snapshot) => {
      orderData = snapshot.val();
      if (!orderData) {
        showNotification("Data order tidak ditemukan", true);
        return;
      }

      // Update UI dengan data order
      pelangganPhone = orderData.PhoneNumber || '';
      document.getElementById('passenger-name').textContent = orderData.name || "Pelanggan";
      document.getElementById('pickup-address').textContent = orderData.alamat_a || "Alamat tidak tersedia";
      document.getElementById('dropoff-address').textContent = orderData.alamat_b || "Alamat tidak tersedia";
      document.getElementById('price').textContent = formatCurrency(orderData.harga);

      // Set lokasi pickup dan dropoff
      pickupCoords = {
        lat: orderData.from_lat,
        lng: orderData.from_lng || orderData.from_ing
      };
      
      dropoffCoords = {
        lat: orderData.to_lat,
        lng: orderData.to_lng || orderData.to_ing
      };

      // Tambahkan marker pickup dan dropoff
      if (!pickupMarker) {
        pickupMarker = new mapboxgl.Marker({ color: '#4CAF50' })
          .setLngLat([pickupCoords.lng, pickupCoords.lat])
          .setPopup(new mapboxgl.Popup().setHTML("<b>Lokasi Penjemputan</b>"))
          .addTo(map);
      }

      if (!dropoffMarker) {
        dropoffMarker = new mapboxgl.Marker({ color: '#FF5252' })
          .setLngLat([dropoffCoords.lng, dropoffCoords.lat])
          .setPopup(new mapboxgl.Popup().setHTML("<b>Lokasi Tujuan</b>"))
          .addTo(map);
      }

      // Fit bounds ke pickup dan dropoff
      const bounds = new mapboxgl.LngLatBounds();
      bounds.extend([pickupCoords.lng, pickupCoords.lat]);
      bounds.extend([dropoffCoords.lng, dropoffCoords.lat]);
      map.fitBounds(bounds, { padding: 50 });

      // Mulai tracking posisi driver
      startTracking();
    });

    // Event listener untuk tombol arrival
    arrivalBtn.addEventListener('click', () => {
      if (isNearPickup && !isPickupCompleted) {
        // Konfirmasi tiba di lokasi penjemputan
        orderRef.update({ 
          status_driver: "tiba_di_jemput",
          waktu_tiba: firebase.database.ServerValue.TIMESTAMP 
        }).then(() => {
          showNotification("Penjemputan diselesaikan");
          arrivalBtn.textContent = "Mulai Mengantar";
          isPickupCompleted = true;
          sendWebString("tiba_di_jemput");
        }).catch(error => {
          showNotification("Gagal update status", true);
        });
        
      } else if (isPickupCompleted) {
        // Konfirmasi mulai pengantaran
        orderRef.update({ 
          status_driver: "dalam_pengantaran",
          waktu_berangkat: firebase.database.ServerValue.TIMESTAMP 
        }).then(() => {
          showNotification("Pesanan sedang diantar");
          arrivalBtn.textContent = "Sedang Mengantar...";
          arrivalBtn.disabled = true;
          sendWebString("mulai_pengantaran");
        }).catch(error => {
          showNotification("Gagal update status", true);
        });
      }
    });
  </script>
</body>
</html>
