<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Detail Order Driver (Mapbox)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Mapbox CSS & JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #ffffff;
      font-weight: bold;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #map {
      height: 300px;
      width: 100%;
      min-height: 250px;
      background: #e9e9e9;
    }
    /* ... (pertahankan style lainnya yang sama) ... */
  </style>
</head>
<body>
  <!-- ... (pertahankan struktur HTML yang sama) ... -->

  <!-- Ganti Leaflet dengan Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Ambil Mapbox API key dari URL
    const urlParams = new URLSearchParams(window.location.search);
    const mapboxToken = urlParams.get('mapboxToken'); // Parameter baru
    
    // Inisialisasi Mapbox
    mapboxgl.accessToken = mapboxToken || 'default_token_jika_kosong'; // Fallback token
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [106.8, -6.2], // Default center
      zoom: 13
    });

    // Variabel marker
    let driverMarker, pickupMarker, dropoffMarker;

    // Fungsi update posisi driver (Mapbox version)
    function updateDriverPosition(lat, lng) {
      const driverCoords = [lng, lat];
      
      if (!driverMarker) {
        // Buat marker driver
        const el = document.createElement('div');
        el.className = 'driver-marker';
        el.innerHTML = 'ðŸš—';
        el.style.fontSize = '20px';
        
        driverMarker = new mapboxgl.Marker(el)
          .setLngLat(driverCoords)
          .setPopup(new mapboxgl.Popup().setHTML("Posisi Anda"))
          .addTo(map);
      } else {
        driverMarker.setLngLat(driverCoords);
      }

      // Hitung jarak ke lokasi penjemputan (gunakan turf.js untuk akurasi)
      if (pickupCoords) {
        const distance = turf.distance(
          turf.point(driverCoords),
          turf.point(pickupCoords),
          { units: 'kilometers' }
        );
        
        document.getElementById('countdown-info').textContent = 
          `Jarak ke penjemputan: ${distance.toFixed(2)} km`;
      }

      // ... (pertahankan logika lainnya)
    }

    // Load data order (sama seperti sebelumnya)
    const urlParams = new URLSearchParams(window.location.search);
    const apiKey = urlParams.get('apiKey');
    const databaseURL = urlParams.get('databaseURL');
    const orderId = urlParams.get('orderId');

    // ... (pertahankan kode Firebase yang sama)

    // Saat data order dimuat:
    function initMapWithOrderData(orderData) {
      pickupCoords = [orderData.from_lng || orderData.from_ing, orderData.from_lat];
      dropoffCoords = [orderData.to_lng || orderData.to_ing, orderData.to_lat];

      // Tambahkan marker penjemputan
      pickupMarker = new mapboxgl.Marker({ color: '#4CAF50' })
        .setLngLat(pickupCoords)
        .setPopup(new mapboxgl.Popup().setHTML("Lokasi Penjemputan"))
        .addTo(map);

      // Tambahkan marker tujuan
      dropoffMarker = new mapboxgl.Marker({ color: '#FF5252' })
        .setLngLat(dropoffCoords)
        .setPopup(new mapboxgl.Popup().setHTML("Lokasi Tujuan"))
        .addTo(map);

      // Fit bounds
      const bounds = new mapboxgl.LngLatBounds()
        .extend(pickupCoords)
        .extend(dropoffCoords);
      map.fitBounds(bounds, { padding: 50 });

      // Mulai tracking
      startTracking();
    }

    // ... (pertahankan fungsi lainnya seperti chatUser(), cancelOrder(), dll)
  </script>
  
  <!-- Load turf.js untuk kalkulasi jarak -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
</body>
</html>
