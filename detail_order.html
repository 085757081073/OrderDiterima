<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Detail Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #ffffff;
      font-weight: bold;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .countdown {
      position: absolute;
      top: 70px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255,255,255,0.9);
      padding: 10px 0;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #map {
      height: 300px;
      width: 100%;
      min-height: 250px;
      background: #e9e9e9;
    }
    .floating-nav {
      position: absolute;
      top: 110px;
      right: 15px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .floating-nav button {
      padding: 10px 15px;
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .order-detail {
      padding: 20px;
      background: white;
      margin-top: -5px;
    }
    .address {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin: 15px 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    .address p {
      margin: 0;
      width: 85%;
      line-height: 1.5;
      color: #333;
    }
    .price {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      color: #333;
    }
    .chat-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #4285F4;
      padding: 5px;
    }
    .cancel-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #FF5252;
      padding: 5px;
    }
    .arrival-btn {
      display: block;
      width: calc(100% - 40px);
      margin: 25px auto;
      padding: 15px;
      background: #f0f0f0;
      color: #888;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: not-allowed;
      text-align: center;
      transition: all 0.3s;
    }
    .arrival-btn.active {
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 12px 25px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 2000;
      display: none;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; top: 10px; }
      to { opacity: 1; top: 20px; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div id="passenger-name">Memuat data...</div>
    <button class="cancel-btn" onclick="cancelOrder()">âœ– Batalkan</button>
  </div>

  <div class="countdown" id="countdown-info">Menghitung jarak...</div>

  <div id="map"></div>

  <div class="floating-nav">
    <button onclick="openNativeMap('pickup')">
      <span style="font-size:18px">ðŸ§­</span> Jemput
    </button>
    <button onclick="openNativeMap('dropoff')">
      <span style="font-size:18px">ðŸ§­</span> Antar
    </button>
  </div>

  <div class="order-detail">
    <div class="address">
      <p id="pickup-address">Memuat alamat penjemputan...</p>
      <button class="chat-btn" onclick="chatUser()">ðŸ’¬</button>
    </div>
    <div class="address">
      <p id="dropoff-address">Memuat alamat tujuan...</p>
    </div>
    <div class="price" id="price">Rp -</div>
    <button class="arrival-btn" id="arrivalBtn">Saya sudah tiba</button>
  </div>

  <div class="notification" id="notification"></div>

  <!-- Leaflet & Firebase -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Variabel global
    let driverMarker, pickupMarker, dropoffMarker;
    let arrivalBtn = document.getElementById('arrivalBtn');
    let isNearPickup = false, isPickupCompleted = false;
    let pelangganPhone = '';
    let pickupCoords, dropoffCoords;
    let orderData = {};

    // Inisialisasi peta
    const map = L.map('map').setView([-6.2, 106.8], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.background = isError ? '#FF5252' : '#4CAF50';
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Fungsi untuk membuka aplikasi maps native
    function openNativeMap(type) {
  if (!orderData) {
    showNotification("Data lokasi belum dimuat", true);
    return;
  }

  let lat, lng;
  if (type === 'pickup') {
    lat = orderData.from_lat;
    lng = orderData.from_lng || orderData.from_ing;
  } else {
    lat = orderData.to_lat;
    lng = orderData.to_lng || orderData.to_ing;
  }

  const urls = {
    androidIntent: `intent://maps.google.com/maps?daddr=${lat},${lng}&directionsmode=driving#Intent;scheme=https;package=com.google.android.apps.maps;end`,
    androidFallback: `https://maps.google.com/maps?daddr=${lat},${lng}&directionsmode=driving`,
    ios: `maps://maps.google.com/maps?daddr=${lat},${lng}&directionsmode=driving`,
    web: `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`
  };

  const isAndroid = /Android/i.test(navigator.userAgent);
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

  if (isAndroid) {
    try {
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = urls.androidIntent;
      document.body.appendChild(iframe);
      
      setTimeout(() => {
        document.body.removeChild(iframe);
        window.location.href = urls.androidFallback;
      }, 500);
    } catch (e) {
      console.error("Error opening intent:", e);
      window.location.href = urls.androidFallback;
    }
  } else if (isIOS) {
    window.location.href = urls.ios;
    setTimeout(() => {
      window.location.href = urls.web;
    }, 500);
  } else {
    window.open(urls.web, '_blank');
  }
}

    // Fungsi untuk memformat nomor telepon
    function formatPhoneNumber(phone) {
      if (!phone) return '';
      let cleaned = phone.replace(/\D/g, '');
      if (cleaned.startsWith('0')) {
        return '62' + cleaned.substring(1);
      } else if (cleaned.startsWith('8')) {
        return '62' + cleaned;
      }
      return cleaned;
    }

    // Fungsi untuk chat pelanggan
    function chatUser() {
      if (!pelangganPhone) {
        showNotification("Nomor pelanggan tidak tersedia", true);
        return;
      }
      
      const formattedPhone = formatPhoneNumber(pelangganPhone);
      const waUrl = `https://wa.me/${formattedPhone}`;
      
      window.open(waUrl, '_blank');
    }

    // Fungsi untuk membatalkan order
    function cancelOrder() {
      if (confirm("Apakah Anda yakin ingin membatalkan order ini?")) {
        if (orderRef) {
          orderRef.update({ 
            status_driver: "dibatalkan",
            waktu_batal: firebase.database.ServerValue.TIMESTAMP 
          }).then(() => {
            showNotification("Order telah dibatalkan");
            sendWebString("cancel_order");
            setTimeout(() => {
              document.body.innerHTML = `
                <div style="text-align:center;margin-top:50px;padding:20px;">
                  <h2>Order telah dibatalkan</h2>
                  <p>Silahkan tutup halaman ini</p>
                </div>`;
            }, 1500);
          }).catch(error => {
            showNotification("Gagal membatalkan order", true);
          });
        }
      }
    }

    // Fungsi untuk mengirim webstring ke native app
    function sendWebString(action) {
      if (window.AndroidInterface) {
        window.AndroidInterface.setWebViewString(`webstring:${action}`);
      } else if (window.webkit && window.webkit.messageHandlers) {
        // Untuk iOS
        window.webkit.messageHandlers.observer.postMessage(`webstring:${action}`);
      } else {
        console.log(`webstring:${action}`); // Fallback untuk debugging
      }
    }

    // Fungsi untuk update posisi driver
    function updateDriverPosition(lat, lng) {
      const driverCoords = L.latLng(lat, lng);
      
      if (!driverMarker) {
        driverMarker = L.marker(driverCoords, {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
            iconSize: [40, 40],
            iconAnchor: [20, 40]
          })
        }).addTo(map).bindPopup("Posisi Anda");
      } else {
        driverMarker.setLatLng(driverCoords);
      }

      // Hitung jarak ke lokasi penjemputan
      const distance = map.distance(driverCoords, pickupCoords);
      const duration = Math.round(distance / 1000 / 0.4 * 60); // Asumsi 40km/jam
      
      document.getElementById('countdown-info').textContent = 
        `Jarak ke penjemputan: ${(distance/1000).toFixed(2)} km - Estimasi: ${duration} menit`;
      
      // Update status tombol berdasarkan jarak
      if (distance < 200 && !isPickupCompleted) {
        isNearPickup = true;
        arrivalBtn.textContent = "Selesaikan Penjemputan";
        arrivalBtn.classList.add('active');
        arrivalBtn.disabled = false;
      } else if (!isPickupCompleted) {
        isNearPickup = false;
        arrivalBtn.textContent = "Saya sudah tiba";
        arrivalBtn.classList.remove('active');
        arrivalBtn.disabled = true;
      }

      // Update posisi driver di Firebase
      if (orderRef) {
        orderRef.update({
          lat_driver: lat,
          lng_driver: lng,
          last_update: firebase.database.ServerValue.TIMESTAMP
        }).catch(error => {
          console.error("Gagal update posisi:", error);
        });
      }
    }

    // Fungsi untuk memulai tracking posisi
    function startTracking() {
      if (navigator.geolocation) {
        const geoOptions = {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 30000
        };
        
        navigator.geolocation.watchPosition(
          (position) => {
            updateDriverPosition(position.coords.latitude, position.coords.longitude);
          },
          (error) => {
            console.error("Error geolocation:", error);
            showNotification("Gagal mendapatkan lokasi", true);
          },
          geoOptions
        );
      } else {
        showNotification("Browser tidak mendukung geolocation", true);
      }
    }

    // Inisialisasi Firebase dan load data
    const urlParams = new URLSearchParams(window.location.search);
    const apiKey = urlParams.get('apiKey');
    const databaseURL = urlParams.get('databaseURL');
    const orderId = urlParams.get('orderId');

    if (!apiKey || !databaseURL || !orderId) {
      showNotification("Parameter URL tidak lengkap", true);
      throw new Error("Missing required URL parameters");
    }

    const firebaseConfig = { apiKey, databaseURL };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const orderRef = db.ref(`pesanan/${orderId}`);

    // Load data order
    orderRef.on("value", (snapshot) => {
      orderData = snapshot.val();
      if (!orderData) {
        showNotification("Data order tidak ditemukan", true);
        return;
      }

      // Update UI dengan data order
      pelangganPhone = orderData.PhoneNumber || '';
      document.getElementById('passenger-name').textContent = orderData.name || "Pelanggan";
      document.getElementById('pickup-address').textContent = orderData.alamat_a || "Alamat tidak tersedia";
      document.getElementById('dropoff-address').textContent = orderData.alamat_b || "Alamat tidak tersedia";
      document.getElementById('price').textContent = formatCurrency(orderData.harga);

// Tambahkan fungsi ini di bagian script
function formatCurrency(amount) {
  if (!amount && amount !== 0) return "Rp -";
  
  const num = Number(amount);
  if (isNaN(num)) {
    console.error("Invalid price format:", amount);
    return "Rp -";
  }
  
  return "Rp" + num.toLocaleString('id-ID');
}
      // Set marker lokasi
      pickupCoords = L.latLng(orderData.from_lat, orderData.from_lng || orderData.from_ing);
      dropoffCoords = L.latLng(orderData.to_lat, orderData.to_lng || orderData.to_ing);

      if (!pickupMarker) {
        pickupMarker = L.marker(pickupCoords, {
          icon: L.divIcon({ className: 'pickup-marker', html: 'ðŸŸ¢', iconSize: [25, 25] })
        }).addTo(map).bindPopup("Lokasi Penjemputan");
      }

      if (!dropoffMarker) {
        dropoffMarker = L.marker(dropoffCoords, {
          icon: L.divIcon({ className: 'dropoff-marker', html: 'ðŸ”´', iconSize: [25, 25] })
        }).addTo(map).bindPopup("Lokasi Tujuan");
      }

      map.fitBounds([pickupCoords, dropoffCoords]);
      startTracking();
    });

    // Event listener untuk tombol arrival
    arrivalBtn.addEventListener('click', () => {
      if (isNearPickup && !isPickupCompleted) {
        // Konfirmasi tiba di lokasi penjemputan
        orderRef.update({ 
          status_driver: "tiba_di_jemput",
          waktu_tiba: firebase.database.ServerValue.TIMESTAMP 
        }).then(() => {
          showNotification("Penjemputan diselesaikan");
          arrivalBtn.textContent = "Mulai Mengantar";
          isPickupCompleted = true;
          sendWebString("tiba_di_jemput");
        }).catch(error => {
          showNotification("Gagal update status", true);
        });
        
      } else if (isPickupCompleted) {
        // Konfirmasi mulai pengantaran
        orderRef.update({ 
          status_driver: "dalam_pengantaran",
          waktu_berangkat: firebase.database.ServerValue.TIMESTAMP 
        }).then(() => {
          showNotification("Pesanan sedang diantar");
          arrivalBtn.textContent = "Sedang Mengantar...";
          arrivalBtn.disabled = true;
          sendWebString("mulai_pengantaran");
        }).catch(error => {
          showNotification("Gagal update status", true);
        });
      }
    });
  </script>
</body>
</html>
