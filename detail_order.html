<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Detail Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const from = params.get('from');
    const to = params.get('to');
    const vehicle = params.get('vehicle');
    const orderId = params.get('order_id');
    const firebaseURL = params.get('firebase_url');

    if (!token || !from || !to || !vehicle || !orderId || !firebaseURL) {
      alert('Parameter kurang');
      throw new Error('Parameter kurang');
    }

    mapboxgl.accessToken = token;

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [0, 0],
      zoom: 13
    });

    const parseCoord = (str) => str.split(',').map(Number).reverse(); // [lng, lat]

    const fromCoord = parseCoord(from);
    const toCoord = parseCoord(to);
    const vehicleParts = vehicle.split(',');
    const vehicleCoord = [parseFloat(vehicleParts[1]), parseFloat(vehicleParts[0])];
    const vehicleType = vehicleParts[2] || 'motor';

    let status = 'menuju_jemput';
    let vehicleMarker;

    const vehicleIcons = {
      motor: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
      mobil: 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
      kurir: 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png',
      default: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png'
    };

    const iconUrl = vehicleIcons[vehicleType] || vehicleIcons.default;
    const el = document.createElement('div');
    el.style.backgroundImage = `url(${iconUrl})`;
    el.style.width = '40px';
    el.style.height = '40px';
    el.style.backgroundSize = 'cover';

    function addRoute(start, end) {
      fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${start.join(',')};${end.join(',')}?geometries=geojson&access_token=${token}`)
        .then(res => res.json())
        .then(data => {
          const route = data.routes[0].geometry;
          if (map.getSource('route')) {
            map.getSource('route').setData({
              type: 'Feature',
              geometry: route
            });
          } else {
            map.addSource('route', {
              type: 'geojson',
              data: {
                type: 'Feature',
                geometry: route
              }
            });
            map.addLayer({
              id: 'route',
              type: 'line',
              source: 'route',
              layout: { 'line-cap': 'round', 'line-join': 'round' },
              paint: { 'line-color': '#00BFFF', 'line-width': 4 }
            });
          }
        });
    }

    function updateFirebase(lat, lng, newStatus = null) {
      fetch(`${firebaseURL}/pesanan/${orderId}.json`, {
        method: 'PATCH',
        body: JSON.stringify({
          lat_driver: lat,
          lng_driver: lng,
          ...(newStatus ? { status: newStatus } : {})
        })
      });
    }

    function distance(a, b) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371e3;
      const φ1 = toRad(a[1]), φ2 = toRad(b[1]);
      const Δφ = toRad(b[1] - a[1]);
      const Δλ = toRad(b[0] - a[0]);
      const a2 = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a2), Math.sqrt(1 - a2));
    }

    map.on('load', () => {
      map.addControl(new mapboxgl.NavigationControl());

      new mapboxgl.Marker({ color: '#4CAF50' }).setLngLat(fromCoord).setPopup(new mapboxgl.Popup().setText("Titik Jemput")).addTo(map);
      new mapboxgl.Marker({ color: '#FF5252' }).setLngLat(toCoord).setPopup(new mapboxgl.Popup().setText("Tujuan")).addTo(map);

      vehicleMarker = new mapboxgl.Marker(el).setLngLat(vehicleCoord).addTo(map);

      addRoute(vehicleCoord, fromCoord);

      map.fitBounds([fromCoord, toCoord, vehicleCoord], { padding: 60 });

      setInterval(() => {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const coord = [lng, lat];

          vehicleMarker.setLngLat(coord);
          updateFirebase(lat, lng);

          if (status === 'menuju_jemput' && distance(coord, fromCoord) < 50) {
            status = 'menuju_tujuan';
            updateFirebase(lat, lng, 'tiba_di_jemput');
            addRoute(coord, toCoord);
          } else if (status === 'menuju_tujuan' && distance(coord, toCoord) < 50) {
            status = 'selesai';
            updateFirebase(lat, lng, 'selesai');
            alert("Perjalanan selesai");
          }
        });
      }, 5000);
    });
  </script>
</body>
</html>
