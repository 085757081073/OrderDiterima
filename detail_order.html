<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Detail Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
  <style>
    /* [Previous CSS remains exactly the same] */
  </style>
</head>
<body>
  <!-- [Previous HTML structure remains exactly the same] -->

  <script>
    // Global variables
    let map;
    let directions;
    let driverMarker;
    let orderRef;
    let isNearPickup = false;
    let isPickupCompleted = false;
    let pelangganPhone = '';
    let pickupCoords, dropoffCoords;

    // Initialize Mapbox
    function initMapbox() {
      const urlParams = new URLSearchParams(window.location.search);
      const mapboxToken = urlParams.get('mapboxToken');
      
      if (!mapboxToken) {
        showNotification("Mapbox token tidak ditemukan", true);
        return null;
      }
      
      mapboxgl.accessToken = mapboxToken;
      
      // Initialize map
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [106.8, -6.2],
        zoom: 13
      });
      
      map.addControl(new mapboxgl.NavigationControl());
      
      directions = new MapboxDirections({
        accessToken: mapboxgl.accessToken,
        unit: 'metric',
        profile: 'mapbox/driving',
        controls: { inputs: false, instructions: false, profileSwitcher: false },
        interactive: false
      });
      
      map.addControl(directions, 'top-left');
      
      return map;
    }

    // [Keep showNotification, formatCurrency functions exactly the same]

    // REVISED WEBSTRING FUNCTION - SIMPLIFIED AND MORE RELIABLE
    function sendWebString(action) {
      const webString = `webstring:${action}`;
      
      // 1. Try Android interface first
      try {
        if (window.AndroidInterface && window.AndroidInterface.setWebViewString) {
          window.AndroidInterface.setWebViewString(webString);
          return;
        }
      } catch (e) { console.log("Android interface not available"); }
      
      // 2. Try iOS interface
      try {
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.observer) {
          window.webkit.messageHandlers.observer.postMessage(webString);
          return;
        }
      } catch (e) { console.log("iOS interface not available"); }
      
      // 3. Fallback to URL scheme (works for both platforms)
      try {
        window.location.href = `jsbridge://${webString}`;
      } catch (e) { console.log("URL scheme not available"); }
      
      // 4. Final fallback to console
      console.log("WEBSTRING:", webString);
    }

    // REVISED NAVIGATION FUNCTION - ENSURES WEBSTRING IS SENT
    function navigateTo(type) {
      if (!pickupCoords || !dropoffCoords) {
        showNotification("Lokasi belum dimuat", true);
        return;
      }
      
      const coords = type === 'pickup' ? pickupCoords : dropoffCoords;
      sendWebString(`navigate_${type}_${coords.lng},${coords.lat}`);
      
      // Additional fallback to native maps
      const url = `https://www.google.com/maps/dir/?api=1&destination=${coords.lat},${coords.lng}&travelmode=driving`;
      window.open(url, '_blank');
    }

    // REVISED CHAT FUNCTION - WITH PHONE NUMBER VALIDATION
    function chatUser() {
      if (!pelangganPhone) {
        showNotification("Nomor pelanggan tidak tersedia", true);
        return;
      }
      
      // Clean phone number
      const cleanPhone = pelangganPhone.replace(/^0/, '62').replace(/\D/g, '');
      sendWebString(`chat_${cleanPhone}`);
      
      // Fallback to WhatsApp Web
      window.open(`https://wa.me/${cleanPhone}`, '_blank');
    }

    // REVISED CANCEL ORDER - WITH CONFIRMATION
    function cancelOrder() {
      if (!confirm("Apakah Anda yakin ingin membatalkan order ini?")) return;
      
      sendWebString("cancel_order");
      
      if (orderRef) {
        orderRef.update({ 
          status_driver: "dibatalkan",
          waktu_batal: firebase.database.ServerValue.TIMESTAMP 
        }).catch(error => {
          showNotification("Gagal membatalkan order", true);
        });
      }
    }

    // [Keep updateDriverPosition, startTracking functions the same]

    // Initialize the app - WITH ERROR HANDLING
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Initialize Mapbox
        map = initMapbox();
        if (!map) return;
        
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('apiKey');
        const databaseURL = urlParams.get('databaseURL');
        const orderId = urlParams.get('orderId');
        
        if (!apiKey || !databaseURL || !orderId) {
          showNotification("Parameter URL tidak lengkap", true);
          return;
        }
        
        // Initialize Firebase
        firebase.initializeApp({ apiKey, databaseURL });
        orderRef = firebase.database().ref(`pesanan/${orderId}`);
        
        // Load order data
        orderRef.on("value", (snapshot) => {
          try {
            const orderData = snapshot.val();
            if (!orderData) {
              showNotification("Data order tidak ditemukan", true);
              return;
            }
            
            // Update UI
            document.getElementById('passenger-name').textContent = orderData.name || "Pelanggan";
            document.getElementById('pickup-address').textContent = orderData.alamat_a || "Alamat tidak tersedia";
            document.getElementById('dropoff-address').textContent = orderData.alamat_b || "Alamat tidak tersedia";
            document.getElementById('price').textContent = formatCurrency(orderData.harga);
            pelangganPhone = orderData.PhoneNumber || '';
            
            // Set coordinates
            if (orderData.from_lat && orderData.from_lng) {
              pickupCoords = { lat: orderData.from_lat, lng: orderData.from_lng };
              new mapboxgl.Marker({ color: '#4CAF50' })
                .setLngLat([pickupCoords.lng, pickupCoords.lat])
                .addTo(map);
            }
            
            if (orderData.to_lat && orderData.to_lng) {
              dropoffCoords = { lat: orderData.to_lat, lng: orderData.to_lng };
              new mapboxgl.Marker({ color: '#FF5252' })
                .setLngLat([dropoffCoords.lng, dropoffCoords.lat])
                .addTo(map);
            }
            
            if (pickupCoords && dropoffCoords) {
              const bounds = new mapboxgl.LngLatBounds();
              bounds.extend([pickupCoords.lng, pickupCoords.lat]);
              bounds.extend([dropoffCoords.lng, dropoffCoords.lat]);
              map.fitBounds(bounds, { padding: 50 });
            }
            
            startTracking();
          } catch (e) {
            console.error("Error loading order data:", e);
            showNotification("Gagal memuat data order", true);
          }
        });
        
        // Arrival button handler - WITH WEBSTRING
        document.getElementById('arrivalBtn').addEventListener('click', function() {
          if (!isPickupCompleted && isNearPickup) {
            sendWebString("pickup_completed");
            orderRef.update({ 
              status_driver: "tiba_di_jemput",
              waktu_tiba: firebase.database.ServerValue.TIMESTAMP 
            }).catch(error => {
              showNotification("Gagal update status", true);
            });
          } else if (isPickupCompleted) {
            sendWebString("trip_started");
            orderRef.update({ 
              status_driver: "dalam_pengantaran",
              waktu_berangkat: firebase.database.ServerValue.TIMESTAMP 
            }).catch(error => {
              showNotification("Gagal update status", true);
            });
          }
        });
        
      } catch (e) {
        console.error("Initialization error:", e);
        showNotification("Gagal memulai aplikasi", true);
      }
    });

    // Load Turf.js dynamically
    const turfScript = document.createElement('script');
    turfScript.src = 'https://unpkg.com/@turf/turf@6/turf.min.js';
    document.head.appendChild(turfScript);
  </script>
</body>
</html>
