
</html></html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Detail Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f1f1f1;
      font-weight: bold;
    }
    .countdown {
      position: absolute;
      top: 70px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255,255,255,0.9);
      padding: 5px;
      z-index: 1000;
    }
    #map {
      height: 300px;
    }
    .floating-nav {
      position: absolute;
      top: 100px;
      right: 10px;
      z-index: 1001;
    }
    .floating-nav button {
      padding: 8px 12px;
      margin: 3px 0;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .order-detail {
      padding: 15px;
    }
    .address {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
    }
    .address p {
      margin: 0;
      width: 80%;
    }
    .price {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div id="passenger-name">Penumpang...</div>
    <button onclick="cancelOrder()">‚ùå Batalkan</button>
  </div>

  <div class="countdown" id="countdown-info">Menghitung jarak...</div>
  <div id="map"></div>

  <div class="floating-nav">
    <button onclick="openNav('pickup')">üß≠ Jemput</button>
    <button onclick="openNav('dropoff')">üß≠ Antar</button>
  </div>

  <div class="order-detail">
    <div class="address">
      <p id="pickup-address">Alamat jemput...</p>
      <button onclick="chatUser()">üí¨</button>
    </div>
    <div class="address">
      <p id="dropoff-address">Alamat tujuan...</p>
    </div>
    <div class="price" id="price">Rp -</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const firebaseURL = getParam('url');
    const orderKey = getParam('order') || 'current';

    const firebaseConfig = {
      apiKey: "dummy",
      databaseURL: firebaseURL
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map = L.map('map').setView([-1.2691, 116.8253], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let driverMarker;

    db.ref("drivers/" + orderKey).once("value").then(snapshot => {
      const data = snapshot.val();
      if (!data) return;

      document.getElementById('passenger-name').textContent = data.name || "Penumpang";
      document.getElementById('pickup-address').textContent = data.alamat_a;
      document.getElementById('dropoff-address').textContent = data.alamat_b;
      document.getElementById('price').textContent = "Rp " + data.harga_total;

      const latlngPickup = L.latLng(data.from_lat, data.from_lng);
      const latlngDropoff = L.latLng(data.to_lat, data.to_lng);

      L.marker(latlngPickup).addTo(map).bindPopup("üìç Jemput");
      L.marker(latlngDropoff).addTo(map).bindPopup("üìç Tujuan");
      map.fitBounds([latlngPickup, latlngDropoff]);

      const vehicle = data.vehicle || 'motor';
      const iconURL = {
        motor: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
        mobil: 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
        kurir: 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png'
      }[vehicle];

      db.ref("drivers/" + orderKey + "/location").on("value", locSnap => {
        const loc = locSnap.val();
        if (!loc) return;

        const driverPos = L.latLng(loc.lat, loc.lng);
        if (!driverMarker) {
          driverMarker = L.marker(driverPos, {
            icon: L.icon({
              iconUrl: iconURL,
              iconSize: [40, 40],
              iconAnchor: [20, 40],
              popupAnchor: [0, -40]
            })
          }).addTo(map);
        } else {
          driverMarker.setLatLng(driverPos);
        }

        const jarak = map.distance(driverPos, latlngPickup) / 1000;
        const waktu = Math.round(jarak / 0.4 * 60);
        document.getElementById('countdown-info').textContent =
          `Jarak ke jemput: ${jarak.toFixed(2)} km - Estimasi: ${waktu} menit`;
      });
    });

    function openNav(type) {
      db.ref("drivers/" + orderKey).once("value").then(snapshot => {
        const data = snapshot.val();
        let targetLat = type === "pickup" ? data.from_lat : data.to_lat;
        let targetLng = type === "pickup" ? data.from_lng : data.to_lng;
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLng}`, '_blank');
      });
    }

    function chatUser() {
      alert("Membuka fitur chat penumpang...");
    }

    function cancelOrder() {
      if (confirm("Yakin ingin membatalkan order?")) {
        db.ref("drivers/" + orderKey).remove();
        alert("Order dibatalkan.");
      }
    }
  </script>
</body>
</html>
